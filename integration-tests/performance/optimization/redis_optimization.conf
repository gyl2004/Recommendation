# Redis性能优化配置文件
# 适用于智能内容推荐平台的高并发场景

# =============================================
# 基础配置
# =============================================

# 绑定地址 (生产环境建议绑定内网IP)
bind 0.0.0.0

# 端口
port 6379

# 后台运行
daemonize yes

# PID文件
pidfile /var/run/redis_6379.pid

# 日志级别 (debug, verbose, notice, warning)
loglevel notice

# 日志文件
logfile /var/log/redis/redis-server.log

# 数据库数量
databases 16

# =============================================
# 内存配置
# =============================================

# 最大内存限制 (建议设置为系统内存的75%)
maxmemory 6gb

# 内存淘汰策略 (推荐使用allkeys-lru)
maxmemory-policy allkeys-lru

# 内存采样数量 (用于LRU算法)
maxmemory-samples 5

# =============================================
# 持久化配置
# =============================================

# RDB持久化配置
save 900 1      # 900秒内至少1个key发生变化
save 300 10     # 300秒内至少10个key发生变化
save 60 10000   # 60秒内至少10000个key发生变化

# RDB文件名
dbfilename dump.rdb

# RDB文件目录
dir /var/lib/redis

# RDB文件压缩
rdbcompression yes

# RDB文件校验
rdbchecksum yes

# AOF持久化 (推荐关闭以提高性能)
appendonly no

# AOF文件名
appendfilename "appendonly.aof"

# AOF同步策略
appendfsync everysec

# AOF重写配置
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# =============================================
# 网络配置
# =============================================

# TCP监听队列长度
tcp-backlog 511

# 客户端超时时间 (0表示永不超时)
timeout 300

# TCP keepalive
tcp-keepalive 300

# 最大客户端连接数
maxclients 10000

# =============================================
# 性能优化配置
# =============================================

# 哈希表配置
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表配置
list-max-ziplist-size -2
list-compress-depth 0

# 集合配置
set-max-intset-entries 512

# 有序集合配置
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog配置
hll-sparse-max-bytes 3000

# 流配置
stream-node-max-bytes 4096
stream-node-max-entries 100

# =============================================
# 慢查询配置
# =============================================

# 慢查询阈值 (微秒)
slowlog-log-slower-than 10000

# 慢查询日志长度
slowlog-max-len 128

# =============================================
# 客户端缓冲区配置
# =============================================

# 普通客户端缓冲区限制
client-output-buffer-limit normal 0 0 0

# 副本客户端缓冲区限制
client-output-buffer-limit replica 256mb 64mb 60

# 发布订阅客户端缓冲区限制
client-output-buffer-limit pubsub 32mb 8mb 60

# =============================================
# 高级配置
# =============================================

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b835c3f8a5d9e7f2"
rename-command SHUTDOWN "SHUTDOWN_b835c3f8a5d9e7f2"
rename-command DEBUG ""
rename-command EVAL ""

# 启用保护模式
protected-mode yes

# 密码认证 (生产环境必须设置)
requirepass your_strong_password_here

# =============================================
# 集群配置 (如果使用Redis集群)
# =============================================

# 启用集群模式
# cluster-enabled yes

# 集群配置文件
# cluster-config-file nodes-6379.conf

# 集群节点超时时间
# cluster-node-timeout 15000

# 集群故障转移超时时间
# cluster-replica-validity-factor 10

# 集群迁移屏障
# cluster-migration-barrier 1

# 集群要求完整覆盖
# cluster-require-full-coverage yes

# =============================================
# 监控配置
# =============================================

# 启用延迟监控
latency-monitor-threshold 100

# =============================================
# 安全配置
# =============================================

# 禁用某些命令
# rename-command EVAL ""
# rename-command SCRIPT ""

# 限制客户端查询缓冲区
client-query-buffer-limit 1gb

# 限制协议缓冲区
proto-max-bulk-len 512mb

# =============================================
# 推荐平台特定配置
# =============================================

# 针对推荐系统的数据库分配
# 数据库0: 用户特征缓存
# 数据库1: 推荐结果缓存
# 数据库2: 内容特征缓存
# 数据库3: 热门内容缓存
# 数据库4: 用户行为缓存
# 数据库5: 会话缓存

# =============================================
# 性能调优参数
# =============================================

# IO线程数 (Redis 6.0+)
io-threads 4
io-threads-do-reads yes

# 内存碎片整理
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# 惰性删除
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# =============================================
# 监控脚本配置
# =============================================

# Redis监控信息获取脚本
# redis-cli info memory
# redis-cli info stats
# redis-cli info clients
# redis-cli info replication
# redis-cli slowlog get 10

# =============================================
# 备份配置
# =============================================

# 自动备份脚本 (在crontab中配置)
# 0 2 * * * /usr/local/bin/redis-cli --rdb /backup/redis/dump_$(date +\%Y\%m\%d).rdb

# =============================================
# 集群监控配置
# =============================================

# 如果使用Redis Sentinel
# sentinel monitor mymaster 127.0.0.1 6379 2
# sentinel down-after-milliseconds mymaster 30000
# sentinel parallel-syncs mymaster 1
# sentinel failover-timeout mymaster 180000

# =============================================
# 性能测试配置
# =============================================

# 测试期间的临时配置
# save ""  # 禁用RDB持久化以提高性能
# appendonly no  # 禁用AOF持久化

# 增加客户端连接数
# maxclients 50000

# 调整内存策略
# maxmemory-policy noeviction  # 测试期间不淘汰数据